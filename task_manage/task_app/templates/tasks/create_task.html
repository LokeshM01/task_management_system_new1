<!-- task_app/templates/tasks/create_task.html -->

{% extends "base_generic.html" %}

{% block content %}
  <style>
    /* Inline CSS for Task Detail Page */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 0;
    }

    h2 {
      color: #4CAF50;
      font-size: 28px;
      margin-bottom: 20px;
    }

    .form-container, .task-details-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .button-container {
      display: flex;
      gap: 10px;
    }

    .btn {
      background-color: #1ABC9C;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background-color: #16A085;
    }

    /* Popup confirmation styling */
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      text-align: center;
      z-index: 1000;
    }

    .popup button {
      background-color: #1ABC9C;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>

  <h2>Create Task</h2>

  <div class="form-container">
    <!-- Task Creation Form -->
    <form id="taskForm" method="post" enctype="multipart/form-data" action="{% url 'create_task' %}">

      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <!-- Task Details: Show only if task was successfully created (e.g., task_id is available) -->
  {% if task and task.task_id %}
    <div class="task-details-container">
      <h3>Task Details</h3>
      <div class="task-detail-field"><strong>Task ID:</strong> {{ task.task_id }}</div>
      <div class="task-detail-field"><strong>Assigned By:</strong> {{ task.assigned_by.username }}</div>
      <div class="task-detail-field"><strong>Assigned To:</strong> {{ task.assigned_to.username }}</div>
      <div class="task-detail-field"><strong>Department:</strong> {{ task.department.name }}</div>
      <div class="task-detail-field"><strong>Status:</strong> {{ task.status_update_assignee }}</div>
      <div class="task-detail-field"><strong>Deadline:</strong> {{ task.deadline }}</div>
      <div class="task-detail-field"><strong>Task Summary:</strong> {{ task.task_summary }}</div>
      <div class="task-detail-field"><strong>Comments by Manager:</strong> {{ task.comments_by_manager }}</div>
      <div class="task-detail-field"><strong>Comments by Assignee:</strong> {{ task.comments_by_assignee }}</div>
    </div>
  {% endif %}

  <!-- Popup confirmation message -->
  <div class="popup" id="popup">
    <p>Task created successfully!</p>
    <button onclick="closePopup()">Close</button>
  </div>

  <script>
    document.querySelector("#taskForm").addEventListener("submit", function(event) {
      event.preventDefault();  // Prevent default form submission
      let form = this;
      
      // Perform AJAX request
      fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          showPopup(data.message);
          // Display task details dynamically (optional, if needed for AJAX)
          // Here you may need additional JS to update the task details section dynamically.
        }
      });
    });

    // Show popup confirmation
    function showPopup(message) {
      const popup = document.getElementById("popup");
      popup.style.display = "block";
      popup.querySelector("p").innerText = message;
    }

    // Close popup
    function closePopup() {
      const popup = document.getElementById("popup");
      popup.style.display = "none";
      document.getElementById("taskForm").reset();  // Clear the form
    }
  </script>
{% endblock %}
